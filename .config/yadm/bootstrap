#!/bin/bash
set -e

trap 'catch' ERR
catch() {
	echo "Bootstrapping failed!"
	kill $!
}

trap cleanUp SIGHUP SIGINT SIGTERM
cleanUp() {
	echo "cleaning up"
}

OS="$(uname -s)"
if [ "${OS}" == "Linux" ]; then
	DISTRO_ID=$(lsb_release -is)
fi

SUPPORTED_DEBIAN_ID=("Pop Ubuntu Debian")
SUPPORTED_REDHAT_ID=("Fedora")

linuxInstall() {

	if [[ " ${SUPPORTED_DEBIAN_ID[*]} " =~ ${DISTRO_ID} ]]; then
		sudo apt-get install build-essential procps curl file git -y
		sudo apt-get install kitty -y
	elif
		[[ " ${SUPPORTED_REDHAT_ID[*]} " =~ ${DISTRO_ID} ]]
	then
		sudo dnf installl groupinstall 'Development Tools'
		sudo dnf install kitty
	else
		echo"Linux distro $DISTRO_ID not supported!"
		exit 1
	fi

	brewBundleInstall

	wget -O /tmp/Hack.zip https://github.com/ryanoasis/nerd-fonts/releases/download/v2.1.0/Hack.zip
	unzip -o /tmp/Hack.zip -d "$HOME/.local/share/fonts"
	fc-cache -fv
}

macOsInstall() {

	brewBundleInstall
	brew install kitty
	brew install font-hack-nerd-font
}

brewBundleInstall() {

	/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
	eval "$(${brew_path} shellenv)"
	brew bundle --file "$(dirname "$0")/Brewfile"
}

selectShell() {

	PS3='Choose your favorite shell: '
	shells=("Bash" "ZSH" "Fish")
	select shell in "${shells[@]}"; do
		case $shell in
		"Bash")
			sudo chsh -s /bin/bash "$USER"
			defaultShell="bash"
			break
			;;
		"Fish")
			sudo chsh -s "$fish_path" "$USER"
			defaultShell="fish"
			break
			;;
		"ZSH")
			sudo chsh -s "$zsh_path" "$USER"
			defaultShell="zsh"
			break
			;;
		*)
			selectShell
			;;
		esac
	done
}

echo "stashing conflicting existing config files. To revert thus, run the command: yadm stash pop"
yadm stash

if [ "$OS" == "Darwin" ]; then
	brew_path="/opt/homebrew/bin/brew"
	macOsInstall
elif [ "$OS" == "Linux" ]; then
	brew_path="/home/linuxbrew/.linuxbrew/bin/brew"
	linuxInstall
else
	echo "This OS is not supported"
	exit 1
fi

volta install node@lts

if [[ ! -d $HOME/.oh-my-zsh ]]; then
	sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --keep-zshrc --unattended
fi

zsh_path=$(which zsh)
if ! grep -q "^${zsh_path}$" "/etc/shells"; then
	echo "$zsh_path" | sudo tee -a /etc/shells
fi

if [[ ! -d $HOME/.local/share/omf ]]; then
	curl https://raw.githubusercontent.com/oh-my-fish/oh-my-fish/master/bin/install --noninteractive | fish
fi

fish_path=$(which fish)
if ! grep -q "^${fish_path}$" "/etc/shells"; then
	echo "$fish_path" | sudo tee -a /etc/shells
fi

selectShell
$defaultShell
echo "Done."
